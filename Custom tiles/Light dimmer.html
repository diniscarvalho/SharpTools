<!-- 
  README
  Create a SmartThings 'Personal Access Token' with access to devices and use it
  for the 'token' setting in the tile.

  https://account.smartthings.com/tokens

  Light dimmer created by Dinis Carvalho, inspired by Joshua's scenes tile:
  https://github.com/joshualyon/custom-tile-demos/tree/main/smartthings-scenes/
-->

<!-- Do not edit below -->
<script type="application/json" id="tile-settings">
    {
      "schema": "0.1.0",
      "settings": [
        {"name": "token", "label": "Token", "type": "STRING"},
        {"name": "LightID", "label": "Light ID", "type": "STRING"}
      ],
      "name": "Light dimmer [shortyyy]"
    }
    </script>
    <!-- Do not edit above -->
    
    <!-- Styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.5.1/nouislider.css" integrity="sha512-MKxcSu/LDtbIYHBNAWUQwfB3iVoG9xeMCm32QV5hZ/9lFaQZJVaXfz9aFa0IZExWzCpm7OWvp9zq9gVip/nLMg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
    .main-content {
        display: flex;
        align-items: center;
        justify-content: center;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        padding-top: 10px;
    }
    .slider-wrapper {
        width: 90px;
        height: 210px;
          border-radius: 8px;
    }
    .noUi-target {
        background-color: rgb(255 255 255 / 30%);
        border: 0;
        box-shadow: none;
        backdrop-filter: blur(8px);
          border-radius: 8px;
    }
    .noUi-connect {
        background: rgb(255 255 255 / 30%);
          border-radius: 8px;
    }
    .noUi-handle {
        opacity: 0;
        width: 90px !important;
        height: 50% !important;
        margin: 0 !important;
        right: 0 !important;
    }
    
    </style>
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.5.1/nouislider.min.js" integrity="sha512-T5Bneq9hePRO8JR0S/0lQ7gdW+ceLThvC80UjwkMRz+8q+4DARVZ4dqKoyENC7FcYresjfJ6ubaOgIE35irf4w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.sharptools.io/js/custom-tiles.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script>
    var content = document.getElementById("mainContent");
    var patToken = null;
    var deviceId = null;
    var devices = [];
    var baseUrl = "https://api.smartthings.com/v1/devices";
    
    function addEvents() {
        var slider = document.querySelector(".slider-wrapper");    
        noUiSlider.create(slider, {
            start: 50,
              connect: "lower",
            direction: 'rtl',
            orientation: 'vertical',
            range: {
                'min': 0,
                'max': 100
            }
        });  
        slider.noUiSlider.on('change', function () {  
            var value = slider.noUiSlider.get();
              console.log(value);
              executeCommand(deviceId, value);
        });
    }
    
    function getAxiosConfig(){
        return { "headers": { "Authorization": "Bearer " + patToken } }
    }
        
    stio.ready((data)=>{
        console.log("stio library is ready with token", data.settings.token);
        console.log("device ID token", data.settings.LightID);
        if(data.settings.token == null || data.settings.LightID == null){
            console.log("Tile not configured properly");
            return;
        }
        else{
            patToken = data.settings.token;
            deviceId = data.settings.LightID;
        }    
        // to do: get current dim level
        addEvents();
    });
    
    function executeCommand(deviceId, value) {
        var data = `{"commands": [{
                "component": "main",
                "capability": "switchLevel",
                "command": "setLevel",
                "arguments": [` + value + `]
            }]}`;
        axios.post(baseUrl + '/' + deviceId + '/commands', data, getAxiosConfig()).then(function(response) {
            console.log('Response Status', response.status);
        });
    }   
    </script>
    
    <!-- HTML -->
    <div class="main-content" id="mainContent">
        <div class="slider-wrapper"></div>
    </div>